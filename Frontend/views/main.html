<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="author" content="Wyatt Mogelson">
    <title>Unfollow Finder</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div style = "text-align: center;"> 
        <div>
            <h1> <img src = "/images/instagram_logo.svg" width="24.004" height="24" title="instagram_logo"> Instagram Unfollower Tool <button id = "logout">Logout</button></h1>
        </div>
        <hr>
        <div>
            <p1>Check who unfollowed you with one simple file upload:</p1>
        </div>
        <br><br>
        <form>
            <div>
                <label for="fname">Upload File:</label>
                <input type="file" id="files" name="file" accept = ".html" multiple>
                <p id = "message"><br></p>
                <button id = "submit">Submit</button>
                <br><br>
                <table id = "userTable">
                    <thead>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
                <h1 id = "output"></h1>
            </div>
            <br>
            <br>
        </form>
        <br>
        <script> 
            const submitBtn = document.getElementById("submit") 
            const logoutBtn = document.getElementById("logout") 
            const inputFile = document.getElementById("files")
            const output = document.getElementById("output")
            const baseUrl = 'http://localhost:8383'
            // submitBtn.addEventListener('click', recieveInfo)
            submitBtn.addEventListener('click', sendInfo)
            logoutBtn.addEventListener('click', logOut)
            async function logOut(e) {
                const res = await fetch(baseUrl + '/logout', {
                    method: 'POST',
                
                })
                if (res.ok) {
                    window.location.href = '/index.html';
                }
            }
            // async function recieveInfo(e) { 
            //     e.preventDefault()
            //     const res = await fetch(baseUrl + 'info/wyatt?key=hello', {
            //         method: 'GET' 
            //     })
            //     console.log( res) 
            //     const data = await res.json()
            //     output.textContent = data.info
            // }
            async function sendInfo(e) {
                e.preventDefault()
                if (inputFile.value == '') { return }
                const formData = new FormData()
                for (let i=0; i<files.files.length; i++) {
                    formData.append("files", files.files[i])
                }
                // console.log(...formData)
                const res = await fetch(baseUrl + '/uploads', {
                    method: 'POST',
                    body: formData
                
                })
                if (res.ok) {
                    const data = await res.json()
                    const tableBody = document.querySelector('#userTable tbody');
                    data[0].forEach(user => {
                        const row = document.createElement('tr');
                        const cell = document.createElement('td');
                        cell.textContent = user.following_id;
                        row.appendChild(cell);
                        tableBody.appendChild(row);
                    });
                }
                else {
                    if (res.ok) {
                        document.getElementById("message").textContent = "Succesfully uploaded"
                    }
                    if (res.status === 401) {
                        document.getElementById("message").textContent = "Page timeout, redirecting to login page"
                        logOut()

                    }
                    else if (res.status === 403) {
                        document.getElementById("message").textContent = "Page timeout, redirecting to login page"
                        logOut()
                        
                    }
                    else if (res.status === 500) {
                        // Display file parsing error
                        document.getElementById("message").textContent = "Error with files, are you sure you uploaded the correct files?"
                    }
                }
            }
        </script>
    </div>
</body>
</html>